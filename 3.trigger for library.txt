3: write a trigger for Library (bid, bname, doi, status) to update the number of copies
(noc) according to ISSUE & RETURN status on update or insert query. Increase the
noc if status is RETURN, Decrease noc if status is ISSUE in Library_Audit
table(bid,bname,noc,timestampofquery). Write a trigger after update on Library
such that if doi is more than 20 days ago then status should be FINE and in the
Library_Audit table fine should be equal to no. of days * 10.
-- Main Library Table
CREATE TABLE Library (
bid INT PRIMARY KEY,
bname VARCHAR(100),
doi DATE,
status VARCHAR(10)
);
-- Audit Table
CREATE TABLE Library_Audit (
bid INT,
bname VARCHAR(100),
noc INT,
timestampofquery TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
fine INT DEFAULT 0
);
DELIMITER $$
CREATE TRIGGER trg_status_noc_change
AFTER INSERT ON Library
FOR EACH ROW
BEGIN
DECLARE book_noc INT DEFAULT 0;
IF NEW.status = 'ISSUE' THEN
SET book_noc = -1;
ELSEIF NEW.status = 'RETURN' THEN
SET book_noc = 1;
END IF;
INSERT INTO Library_Audit (bid, bname, noc)
VALUES (NEW.bid, NEW.bname, book_noc);
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER trg_fine_on_overdue
AFTER UPDATE ON Library
FOR EACH ROW
BEGIN
DECLARE overdue_days INT;
DECLARE fine_amt INT;

SET overdue_days = DATEDIFF(CURDATE(), NEW.doi);
IF overdue_days > 20 THEN
SET fine_amt = overdue_days * 10;
INSERT INTO Library_Audit (bid, bname, noc, fine)
VALUES (NEW.bid, NEW.bname, 0, fine_amt);
END IF;
END$$
DELIMITER ;

-- Book issued today
INSERT INTO Library (bid, bname, doi, status)
VALUES (201, 'Java Programming', CURDATE(), 'ISSUE');
-- Book returned today
INSERT INTO Library (bid, bname, doi, status)
VALUES (202, 'MySQL Mastery', CURDATE(), 'RETURN');
-- Book issued 25 days ago (will be updated to test fine)
INSERT INTO Library (bid, bname, doi, status)
VALUES (203, 'Operating Systems', DATE_SUB(CURDATE(), INTERVAL 25 DAY), 'ISSUE');
-- Update to simulate return/fine
UPDATE Library
SET status = 'FINE'
WHERE bid = 203;
SELECT * FROM Library;
SELECT * FROM Library_Audit;